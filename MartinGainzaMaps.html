<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- bootstrap -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="" />
    <!-- Leaflet javascript -->
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
    <title>Aeroterra Test</title>
</head>

<body>
    <div class="container p-0 m-0 mw-100">
        <div class="row w-100 h-100 m-0">
            <div class="col-9 p-0">
                <div id="map" class="h-100"></div>
            </div>
            <div class="col-3 p-0">
                <form action="#" class="float-right py-4 px-5 formulario w-100 h-100 m-0" role="form" id="formulario">
                    <div class="form-group">
                        <label for="nombre">Nombre</label>
                        <input class="form-control" id="nombre" value="Martin" placeholder="ej:Av. E. Madero 1020" required>
                    </div>

                    <div class="form-group">
                        <label for="direccion">Dirección</label>
                        <input class="form-control" value="asdasdasdsa321" id="direccion" placeholder="ej:Av. E. Madero 1020" required>
                    </div>

                    <div class="form-group">
                        <label for="telefono">Teléfono</label>
                        <input class="form-control" value="1131011879" id="telefono" placeholder="ej: 54 9 11 5272 0900">
                    </div>

                    <div class="form-group">
                        <label for="categoria">Categoría</label>
                        <select class="form-control select" id="categoria" title="Seleccionar" required>
                        <option value="" disabled>Seleccionar</option>
                        <option selected>Comercial</option>
                        <option>Residencial</option>
                        <option>Mixta</option>
                    </select>
                    </div>

                    <div class="form-group">
                        <label for="coord">Coord.</label>
                        <input class="form-control" value="-34.597875, -58.369434" id="coord" placeholder="Click en el mapa!" required>
                    </div>
                    <button value="JSON" class="float-left btn btn-warning btn_form" data-toggle="modal" data-target="#Json">JSON</button>
                    <div class="form-group">
                        <input type="submit" id="agregar" value="Agregar" class="float-right btn btn-success btn_form" />
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="Json" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">JSON</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
                </div>
                <div class="modal-body">
                    <p>Puede cargar un JSON con la siguiente estructura por cada marcador:</p>
                    <textarea class="templateJson form-control" rows="8">
[{
    "X": "Ej.: -34.597875",
    "Y": "Ej.: -58.369434",
    "cat": "Comercial/Residencial/Mixta",
    "desc": "Ej.: Av. E. Madero 1020",
    "dir": "Ej.: Av. E. Madero 1020",
    "tel": "Ej.: 1131011879"
}, ... ]                   </textarea>
                    <br>
                    <p>¡También puedes <span>Descargar</span> el JSON de las marcas actuales!</p>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="uploadJson">Upload</span>
                        </div>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="jsonFile" aria-describedby="uploadJson">
                            <label class="custom-file-label" for="jsonFile" id="jsonFileLabel">Choose file</label>
                        </div>
                    </div>
                    <!-- </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" id="cargarJson">Cargar</button>
                    <button type="button" class="btn btn-warning" id="descargarjson">Descargar</button>
                </div> -->
                </div>
            </div>
        </div>
        <!-- Script del mapa -->
        <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
        <script>
            //Verificacion de existencia del ultimo id en localStorage
            if (localStorage.getItem('lastId')) {
                var lastId = localStorage.getItem('lastId')
                    // lastId = 0;
            } else {
                var lastId = 0;
            }
            var idElim = lastId;
            var CirculosEnMapa = [];
            //Creacion del mapa
            var mymap = L.map('map').setView([-34.5966417, -58.374097], 16);
            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                maxZoom: 18,
                attribution: 'Martin Gainza | Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                    '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                    'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                id: 'mapbox.streets'
            }).addTo(mymap);
            //Verificacion de existencia de circulos en localStorage
            if (localStorage.getItem('circulos')) {
                var circulos = JSON.parse(localStorage.getItem('circulos'))
                    // var circulos = []    
                circulos.forEach(circulo => {
                    var circle = L.circle([parseFloat(circulo.X), parseFloat(circulo.Y)], {
                        color: 'red',
                        fillColor: '#8400D3',
                        fillOpacity: 0.5,
                        radius: 10,
                    });
                    circle.bindPopup("<div><b>Descripción:</b>" + circulo.desc + "<br><b>Dirección:</b>" + circulo.dir + "<br><b>Telefónico:</b>" + circulo.tel + "<br><b>(X, Y):</b>" + circulo.X + "," + circulo.Y + "<br><b>Categoria:</b>" + circulo.cat + "<br><button class='btn-danger btn-eliminar' onclick='eliminarCirculo(" + circulo.id + ")'><b>Eliminar</b></button></div>");
                    circle.hiddenId = circulo.id
                    console.log(circle)
                    CirculosEnMapa.push(circle)
                    circle.addTo(mymap)
                });
            } else {
                var circulos = [];
            }
            //Verificaciones 1
            document.getElementById("telefono").onchange = function() {
                    if ((document.getElementById("telefono").value).match(/[^0-9\s-]/g) != null) {
                        console.log((document.getElementById("telefono").value).match(/[^0-9\s-]/g))
                        document.getElementById("telefono").setCustomValidity("El telefono permite solo numeros");
                    } else {
                        document.getElementById("telefono").setCustomValidity("");
                    }
                }
                //Verificaciones 2
            document.getElementById("coord").onchange = function() {
                let analizar = document.getElementById("coord").value;
                if (analizar.split(",").length != 2) {
                    document.getElementById("coord").setCustomValidity("Porfavor siga el ejemplo: 'X,Y'");
                } else {
                    let XY = analizar.split(",")
                    let X = parseFloat(XY[0])
                    let Y = parseFloat(XY[1])
                    if (typeof(X) != "number" || X > 180 || X < -180 || typeof(Y) != "number" || Y > 90 || Y < -90) {
                        document.getElementById("coord").setCustomValidity("Porfavor ingrese dos numeros entre X: -180 y 180 y Y: -90 y 90");
                    } else {
                        document.getElementById("coord").setCustomValidity("");
                    }
                }
            };
            //Toma de datos
            document.getElementById("agregar").onclick = function() {
                    let nombre = document.getElementById("nombre").value
                    let direccion = document.getElementById("direccion").value
                    let telefono = document.getElementById("telefono").value
                    let categoria = document.getElementById("categoria").value
                    let coord = (document.getElementById("coord").value).split(",")
                    agregarCirculo(coord[0], coord[1], nombre, direccion, telefono, categoria);
                }
                //Funcion para agregar circulos con el submit
            function agregarCirculo(X, Y, nombre, direccion, telefono, categoria) {
                var circle = L.circle([parseFloat(X), parseFloat(Y)], {
                    color: 'red',
                    fillColor: '#8400D3',
                    fillOpacity: 0.5,
                    radius: 10,
                });
                circle.hiddenId = lastId;
                lastId++;
                idElim = circle.hiddenId;
                //NO ANDA EL circulo.idElim ctrl +z y probar mas arribva
                circle.bindPopup("<div><b>Descripción:</b>" + nombre + "<br><b>Dirección:</b>" + direccion + "<br><b>Telefónico:</b>" + telefono + "<br><b>(X, Y):</b>" + X + "," + Y + "<br><b>Categoria:</b>" + categoria + "<br><button class='btn-danger btn-eliminar' onclick='eliminarCirculo(idElim)'><b>Eliminar</b></button></div>");
                //Setea el id a eliminar
                circle.on('click', function() {
                        idElim = circle.hiddenId;
                    })
                    //Los guarda para otra para el localStorage
                circulos.push({
                    "X": X,
                    "Y": Y,
                    "desc": nombre,
                    "dir": direccion,
                    "tel": telefono,
                    "cat": categoria,
                    "id": circle.hiddenId
                });
                console.log(circulos[0])
                    //Los guarda para poder eliminarlos despues
                CirculosEnMapa.push(circle);
                localStorage.setItem("circulos", JSON.stringify(circulos))
                localStorage.setItem("lastId", lastId);
                circle.addTo(mymap);
                circle.openPopup();
            }
            //Funcion para eliminar circulos
            function eliminarCirculo(idElim) {
                //Elimina el circulo            
                CirculosEnMapa.forEach(circulo => {
                    if (circulo.hiddenId == idElim) {
                        circulo.removeFrom(mymap);
                    }
                });
                circulos.forEach(circulo => {
                    if (circulo.id == idElim) {
                        circulos.splice(circulos.indexOf(circulo), 1);
                    }
                });
                // circulos = []
                localStorage.setItem("circulos", JSON.stringify(circulos))
            }
            //Funcion establece la posición al clickear en el mapa.
            function onMapClick(e) {
                let coord = e.latlng.toString().substr(7)
                coord = coord.substr(0, coord.length - 1)
                coord = coord.split(",")
                document.getElementById("coord").value = coord[0] + "," + coord[1];
                document.getElementById("coord").setCustomValidity("");
            }
            //Asignacion de la funcion onMapClick
            mymap.on('click', onMapClick);
            //Manejo de eventos para que el puntero cambie de forma a "grabbing" cuando se arrastra
            document.getElementById("map").onmousedown = function() {
                document.getElementById("map").style.cursor = "grabbing";
            }
            document.getElementById("map").onmouseup = function() {
                    document.getElementById("map").style.cursor = "pointer";
                }
                //Carga de File JSon        
            document.getElementById("uploadJson").addEventListener("click", handleFiles, false);
            document.getElementById("jsonFile").addEventListener("change", function() {
                var file = document.getElementById("jsonFile").files[0];
                if (file) {
                    document.getElementById("jsonFileLabel").innerHTML = file.name;
                }
            });

            function handleFiles() {
                var file = document.getElementById("jsonFile").files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.readAsText(file, "UTF-8");
                    reader.onload = function(evt) {
                        try {
                            var circulosNuevos = JSON.parse(evt.target.result)
                        } catch (err) {
                            alert("Error en el JSON\n" + err.message)
                        }
                        if (circulosNuevos) {
                            circulosNuevos.forEach(circulo => {
                                //Faltaria hacer la verificacion del circulo.cat
                                agregarCirculo(circulo.X, circulo.Y, circulo.desc, circulo.dir, circulo.tel, circulo.cat);
                            });
                        }
                    }
                    reader.onerror = function(evt) {
                        console.log("error reading file")
                    }
                } else {
                    alert("Primero seleccione el archivo")
                }
            }
        </script>
        <style>
            .formulario {
                background: #DDD !important;
            }
            
            .btn_form {
                font-family: sans-serif;
                padding: 10px, 10px, 10px, 10px;
                border-radius: 5px;
            }
            
            #map {
                cursor: pointer;
            }
            
            #categoria {
                -webkit-appearance: none;
                -moz-appearance: none;
                -ms-appearance: none;
                appearance: none;
                box-shadow: none;
                border: 0 !important;
                background-image: none;
                background: url("https://cdn4.iconfinder.com/data/icons/blue-set/64/15-512.png") 100% / 18% no-repeat #eee;
            }
            
            #coord {
                background: url("https://cdn4.iconfinder.com/data/icons/small-n-flat/24/map-512.png") 98% / 13% no-repeat #eee;
                height: 45px;
            }
            
            .btn-eliminar {
                border-radius: 5px;
                margin-left: 70%;
                margin-top: 5%;
            }
            
            .templateJson {
                width: 100%;
                height: 13em;
            }
            
            #telefono,
            #nombre,
            #direccion {
                background: #eee !important;
            }
            
            .btn-warning {
                font-weight: 300;
                color: white;
                background: rgb(255, 153, 37);
                border: rgb(255, 153, 37);
            }
            
            .btn-warning:hover {
                font-weight: 300;
                border: rgb(194, 116, 28);
                color: white;
                background: rgb(194, 116, 28);
            }
            
            #uploadJson {
                cursor: pointer;
            }
        </style>
</body>

</html>